<!DOCTYPE html>





<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/echarts.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/echarts.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.3.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"scrollpercent":true,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    save_scroll: false,
    copycode: {"enable":true,"show_result":true,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    }
  };
</script>

  <meta name="description" content="RPC(Remote Procedure Call)：远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的思想.RPC 最核心要解决的问题就是在分布式系统间，如何执行另外一个地址空间上的函数、方法，就仿佛在本地调用一样RPC 主要需要处理几个核心的问题.1：代理  2.通讯  3：序列化 4：服务实例化 在我Raft中只有三种RPC请求. 所以我们不通过代理的方式进">
<meta property="og:type" content="article">
<meta property="og:title" content="Java实现Raft算法_Raft算法之RPC">
<meta property="og:url" content="http://yoursite.com/2020/11/11/Raft_PRC/index.html">
<meta property="og:site_name" content="FILE">
<meta property="og:description" content="RPC(Remote Procedure Call)：远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的思想.RPC 最核心要解决的问题就是在分布式系统间，如何执行另外一个地址空间上的函数、方法，就仿佛在本地调用一样RPC 主要需要处理几个核心的问题.1：代理  2.通讯  3：序列化 4：服务实例化 在我Raft中只有三种RPC请求. 所以我们不通过代理的方式进">
<meta property="og:locale" content="en">
<meta property="og:image" content="c:/Users/leleyi/AppData/Roaming/Typora/typora-user-images/image-20201217221119106.png">
<meta property="og:updated_time" content="2020-12-17T14:11:19.790Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java实现Raft算法_Raft算法之RPC">
<meta name="twitter:description" content="RPC(Remote Procedure Call)：远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的思想.RPC 最核心要解决的问题就是在分布式系统间，如何执行另外一个地址空间上的函数、方法，就仿佛在本地调用一样RPC 主要需要处理几个核心的问题.1：代理  2.通讯  3：序列化 4：服务实例化 在我Raft中只有三种RPC请求. 所以我们不通过代理的方式进">
<meta name="twitter:image" content="c:/Users/leleyi/AppData/Roaming/Typora/typora-user-images/image-20201217221119106.png">
  <link rel="alternate" href="/atom.xml" title="FILE" type="application/atom+xml">
  <link rel="canonical" href="http://yoursite.com/2020/11/11/Raft_PRC/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Java实现Raft算法_Raft算法之RPC | FILE</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <div class="container sidebar-position-left">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">FILE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content page-post-detail">
            

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/11/Raft_PRC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Les">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/echarts.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FILE">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">Java实现Raft算法_Raft算法之RPC

            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-11-11 16:40:15" itemprop="dateCreated datePublished" datetime="2020-11-11T16:40:15+08:00">2020-11-11</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-17 22:11:19" itemprop="dateModified" datetime="2020-12-17T22:11:19+08:00">2020-12-17</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/分布式/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>RPC(Remote Procedure Call)：远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的思想.<br>RPC 最核心要解决的问题就是在分布式系统间，如何执行另外一个地址空间上的函数、方法，就仿佛在本地调用一样<br>RPC 主要需要处理几个核心的问题.1：代理  2.通讯  3：序列化 4：服务实例化</p>
<p>在我Raft中只有三种RPC请求. 所以我们不通过代理的方式进行</p>
<h3 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信:"></a>网络通信:</h3><p>Netty 是一个广泛使用的 Java 网络编程框架.隐藏其背后的复杂性而提供一个易于使用的 API 的客户端/服务器框架。</p>
<p>通过Netty 很容易实现一个高性能的网络通信。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// connector 初始化 之后就已经在监听了.</span></span><br><span class="line">    ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap()</span><br><span class="line">            .group(bossNioEventLoopGroup, workerNioEventLoopGroup)</span><br><span class="line">            .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> Decoder());</span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> Encoder());</span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> FromRemoteHandler(eventBus, inboundChannelGroup));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    logger.debug(<span class="string">"node listen on port &#123;&#125;"</span>, port);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        serverBootstrap.bind(port).sync();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectorException(<span class="string">"failed to bind port"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> NioChannel <span class="title">connect</span><span class="params">(NodeId nodeId, Address address)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 连接到开启监听的服务器</span></span><br><span class="line">    Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap()</span><br><span class="line">            .group(workerGroup)</span><br><span class="line">            .channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">TCP_NODELAY</span>, <span class="title">true</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">CONNECT_TIMEOUT_MILLIS</span>, <span class="title">connectTimeoutMillis</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">handler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> Decoder());</span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> Encoder());</span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> ToRemoteHandler(eventBus, nodeId, selfNodeId));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="comment">// 数据序列化处理都是再Encoder 和 Decoder， Handler 包含了一些逻辑。</span></span><br><span class="line">    ChannelFuture future = bootstrap.connect(address.getHost(), address.getPort()).sync();</span><br><span class="line">    <span class="keyword">if</span> (!future.isSuccess()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">"failed to connect"</span>, future.cause());</span><br><span class="line">    &#125;</span><br><span class="line">    logger.debug(<span class="string">"channel OUTBOUND-&#123;&#125; connected"</span>, nodeId);</span><br><span class="line">    Channel nettyChannel = future.channel();</span><br><span class="line">    nettyChannel.closeFuture().addListener((ChannelFutureListener) cf -&gt; &#123;</span><br><span class="line">        logger.debug(<span class="string">"channel OUTBOUND-&#123;&#125; disconnected"</span>, nodeId);</span><br><span class="line">        channelMap.remove(nodeId);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NioChannel(nettyChannel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化:"></a>序列化:</h3><p>Java 的序列化工具有很多.例如(<strong>Protobuf、Thrift、Avro</strong>)查询比较之后我选择了ProtoBuf (主要是资料多!)</p>
<p>Googel 的 ProtoBuf :protocol buffers 是一种语言无关、平台无关、可扩展的序列化结构数据的方法，它可用于（数据）通信协议、数据存储等。</p>
<blockquote>
<p><strong>语言无关、平台无关</strong>。即 ProtoBuf 支持 Java、C++、Python 等多种语言，支持多个平台</p>
<p><strong>高效</strong>。即比 XML 更小（3 ~ 10倍）、更快（20 ~ 100倍）、更为简单</p>
<p><strong>扩展性、兼容性好</strong>。你可以更新数据结构，而不影响和破坏原有的旧程序</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>序列化工具</th>
<th>序列化速度</th>
<th>序列化文件大小</th>
<th>编程模型复杂度</th>
<th>社区活跃度</th>
<th>jar包大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>kryo</td>
<td>极快</td>
<td>小</td>
<td>简单</td>
<td>高</td>
<td>132kb</td>
</tr>
<tr>
<td>fst-serializer</td>
<td>快</td>
<td>小</td>
<td>非常简单</td>
<td>高</td>
<td>246kb</td>
</tr>
<tr>
<td>protobuffer</td>
<td>快</td>
<td>较大</td>
<td>较复杂</td>
<td>稳定</td>
<td>329kb</td>
</tr>
<tr>
<td>fastjson</td>
<td>较快</td>
<td>较大</td>
<td>简单</td>
<td>一般</td>
<td>338kb</td>
</tr>
<tr>
<td>jackson</td>
<td>一般</td>
<td>较大</td>
<td>简单</td>
<td>稳定</td>
<td>1.1mb</td>
</tr>
<tr>
<td>gson</td>
<td>较慢</td>
<td>较大</td>
<td>简单</td>
<td>稳定</td>
<td>189kb</td>
</tr>
</tbody>
</table>
</div>
<p><strong>高效</strong>。即比 XML 更小（3 ~ 10倍）、更快（20 ~ 100倍）、更为简单</p>
<p><strong>扩展性、兼容性好</strong>。你可以更新数据结构，而不影响和破坏原有的旧程序.</p>
<p> 需要预先创建Message 即 <strong>.proto文件定义数据结构.</strong> </p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">"org.les"</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">"Protos"</span>;</span><br><span class="line"><span class="comment">// common</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">NodeEndpoint</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> host = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">int32</span> port = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">RequestVoteRpc</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> term = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> candidate_id = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">int32</span> last_log_index = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">int32</span> last_log_term = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>protoc 编译</strong> .proto 文件生成读写接口</p>
<p>在windows如何使用protoc 编译.proto文件<a href="https://leleyi.github.io/2020/10/28/windows protobuf/#more" target="_blank" rel="noopener">简单的windows protobuf .proto文件编译 | FILE (leleyi.github.io)</a> 见该文章.</p>
<p><strong>调用接口实现序列化、反序列化以及读写</strong></p>
<h4 id="编码器"><a href="#编码器" class="headerlink" title="编码器"></a>编码器</h4><p>在发出 ProtoMsg.Message 消息前，还需要对二进制消息进一步封装。</p>
<p>需要预先规定好数据的格式。如下： Type + Length + VAR 分别占了4， 4 + len（VAR）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Protos.RequestVoteRpc protoRpc = Protos.RequestVoteRpc.newBuilder()</span><br><span class="line">                    .setTerm(rpc.getTerm())</span><br><span class="line">                    .setCandidateId(rpc.getCandidateId().getValue())</span><br><span class="line">                    .setLastLogIndex(rpc.getLastLogIndex())</span><br><span class="line">                    .setLastLogTerm(rpc.getLastLogTerm())</span><br><span class="line">                    .build();</span><br><span class="line">     <span class="keyword">this</span>.writeMessage(out, MessageConstants.TYPE, protoResult);</span><br><span class="line"> &#125;	</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeMessage</span><span class="params">(ByteBuf out, <span class="keyword">int</span> messageType, MessageLite message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ByteArrayOutputStream byteOutput = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    message.writeTo(byteOutput);</span><br><span class="line">    out.writeInt(messageType);</span><br><span class="line">    <span class="keyword">this</span>.writeBytes(out, byteOutput.toByteArray());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeMessage</span><span class="params">(ByteBuf out, <span class="keyword">int</span> messageType, <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 4 + 4 + VAR</span></span><br><span class="line">    out.writeInt(messageType);</span><br><span class="line">    <span class="keyword">this</span>.writeBytes(out, bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeBytes</span><span class="params">(ByteBuf out, <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">    out.writeInt(bytes.length);</span><br><span class="line">    out.writeBytes(bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解码器-通过先前的-统一规定-对信息进行解码。"><a href="#解码器-通过先前的-统一规定-对信息进行解码。" class="headerlink" title="解码器 通过先前的 统一规定 对信息进行解码。"></a>解码器 通过先前的 统一规定 对信息进行解码。</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> availableBytes = in.readableBytes();</span><br><span class="line">	<span class="keyword">if</span> (availableBytes &lt; <span class="number">8</span>) &#123;</span><br><span class="line">    	<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	in.markReaderIndex();</span><br><span class="line">	<span class="keyword">int</span> messageType = in.readInt();</span><br><span class="line">	<span class="keyword">int</span> payloadLength = in.readInt();</span><br><span class="line">	<span class="keyword">if</span> (in.readableBytes() &lt; payloadLength) &#123;</span><br><span class="line">    	in.resetReaderIndex();</span><br><span class="line">    	<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">     ByteBuf frame = Unpooled.buffer(length);</span><br><span class="line">     in.readBytes(frame);</span><br><span class="line">    <span class="comment">// 处理数据帧。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Netty中的Handler 来处理具体的任务逻辑.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> remoteId != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">assert</span> channel != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前收到的消息.</span></span><br><span class="line">    <span class="comment">// 收到请求投票</span></span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> RequestVoteRpc) &#123;</span><br><span class="line">        System.out.println(<span class="string">"type requestVote"</span>);</span><br><span class="line">        RequestVoteRpc rpc = (RequestVoteRpc) msg;</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> RequestVoteRpcMessage(rpc, remoteId, channel));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收到投票结果</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> RequestVoteResult) &#123;</span><br><span class="line">        eventBus.post(msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收到追加信息</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> AppendEntriesRpc) &#123;</span><br><span class="line">        AppendEntriesRpc rpc = (AppendEntriesRpc) msg;</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> AppendEntriesRpcMessage(rpc, remoteId, channel));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收到追加信息结果 同样是 heart beart信息.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> AppendEntriesResult) &#123;</span><br><span class="line">        AppendEntriesResult result = (AppendEntriesResult) msg;</span><br><span class="line">        <span class="keyword">if</span> (lastAppendEntriesRpc == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">"no last append entries rpc"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Objects.equals(result.getRpcMessageId(), lastAppendEntriesRpc.getMessageId())) &#123;</span><br><span class="line">                logger.warn(<span class="string">"incorrect append entries rpc message id &#123;&#125;, expected &#123;&#125;"</span>, result.getRpcMessageId(), lastAppendEntriesRpc.getMessageId());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                eventBus.post(<span class="keyword">new</span> AppendEntriesResultMessage(result, remoteId, lastAppendEntriesRpc));</span><br><span class="line">                lastAppendEntriesRpc = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> InstallSnapshotRpc) &#123;</span><br><span class="line">        InstallSnapshotRpc rpc = (InstallSnapshotRpc) msg;</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> InstallSnapshotRpcMessage(rpc, remoteId, channel));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> InstallSnapshotResult) &#123;</span><br><span class="line">        InstallSnapshotResult result = (InstallSnapshotResult) msg;</span><br><span class="line">        <span class="keyword">assert</span> lastInstallSnapshotRpc != <span class="keyword">null</span>;</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> InstallSnapshotResultMessage(result, remoteId, lastInstallSnapshotRpc));</span><br><span class="line">        lastInstallSnapshotRpc = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到收到消息同解码之后.根据消息类型进行对应的程序调用. 这里用到的是观察者的方式.通过事件通知相应订阅者.</p>
<h3 id="EventBus"><a href="#EventBus" class="headerlink" title="EventBus"></a>EventBus</h3><p><strong>EventBus</strong> 是一个开源库，它利用发布/订阅者者模式来对项目进行解耦。Publisher（发布者）通过post（）方法，把Event事件发布出去，Subscriber（订阅者）在onEvent（）方法中接收事件.</p>
<p>上述的post方法主要做了这么几件事：</p>
<ol>
<li><p>根据传入的Event获取对应的订阅列表subscribers</p>
</li>
<li><p>遍历subscribers</p>
</li>
<li><p>如果订阅者是异步的，那么就使用线程池启动执行任务</p>
</li>
<li><p>如果是同步的那么就调用handleEvent方法向订阅者发布消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subscribe</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnReceiveRequestVoteRpc</span><span class="params">(RequestVoteRpcMessage rpcMessage)</span> </span>&#123;</span><br><span class="line">    context.taskExecutor().submit(()</span><br><span class="line">            -&gt; context.connector().replyRequestVote(doProcessRequestVoteRpc(rpcMessage), rpcMessage));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>例如: RequestVotePRC  调用之后. 通过 Ecoder 编码 - 网络传输 - Dcoder 解码  -&gt; 根据请求类型 进行事件的POST. 而订阅者的订阅方法 触发执行逻辑.</p>
<p><img src="C:\Users\leleyi\AppData\Roaming\Typora\typora-user-images\image-20201217221119106.png" alt="image-20201217221119106"></p>
<p>参考:</p>
<p><a href="https://www.cnblogs.com/luozhiyun/p/11324181.html" target="_blank" rel="noopener">https://www.cnblogs.com/luozhiyun/p/11324181.html</a></p>
<p><a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="noopener">https://developers.google.com/protocol-buffers/docs/overview</a></p>
<p><a href="https://www.baeldung.com/netty" target="_blank" rel="noopener">https://www.baeldung.com/netty</a></p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2020/11/09/Java实现Raft算法/" rel="next" title="Java实现Raft算法_理论知识">
                  <i class="fa fa-chevron-left"></i> Java实现Raft算法_理论知识
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2020/11/13/Raft_RPC_I/" rel="prev" title="Java实现Raft算法_Raft算法之Connector">
                  Java实现Raft算法_Raft算法之Connector <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/echarts.png"
      alt="Les">
  <p class="site-author-name" itemprop="name">Les</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span>
        
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



        </div>
      </div>
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#网络通信"><span class="nav-number">1.</span> <span class="nav-text">网络通信:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化"><span class="nav-number">2.</span> <span class="nav-text">序列化:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#编码器"><span class="nav-number">2.1.</span> <span class="nav-text">编码器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解码器-通过先前的-统一规定-对信息进行解码。"><span class="nav-number">2.2.</span> <span class="nav-text">解码器 通过先前的 统一规定 对信息进行解码。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus"><span class="nav-number">3.</span> <span class="nav-text">EventBus</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Les</span>
</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
    
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

<script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>


  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>


<script src="/js/next-boot.js?v=7.3.0"></script>




  




























  

  
    
      <script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', function() {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    
  

  

  


  
  <script src="/js/scrollspy.js?v=7.3.0"></script>
<script src="/js/post-details.js?v=7.3.0"></script>


</body>
</html>
